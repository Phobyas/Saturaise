<style>
/* OPTIMIZED STYLES - Preserving hover and mix-blend-mode functionality */
.product-loop__img-wrapper {
  position: relative;
  width: 100%;
  padding-bottom: 100%;
  overflow: hidden;
  background: #eeeeee;
  display: flex;
  align-items: center;
  justify-content: center;
  contain: layout style; /* Performance optimization */
}

.product-loop__img-wrapper img {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 100%;
  max-height: 100%;
  width: auto !important;
  height: auto !important;
  object-fit: contain;
  mix-blend-mode: multiply; /* Preserved */
}

.image-wrapper-link {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Hover image with preserved functionality */
.hover-image {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #eeeeee;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  z-index: 2;
  display: flex; /* Added for proper centering */
  align-items: center;
  justify-content: center;
}

.hover-image img {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 100%;
  max-height: 100%;
  width: auto !important;
  height: auto !important;
  object-fit: contain;
  mix-blend-mode: multiply; /* Preserved */
}

/* Hover states - preserved original behavior */
.product-loop__img-wrapper:hover .hover-image {
  opacity: 1;
  visibility: visible;
}

.product-loop__img-wrapper:hover .main-image {
  opacity: 0;
}

.main-image {
  transition: opacity 0.3s ease;
  position: relative;
  z-index: 1;
}

/* Product image container */
.product-image {
  border-radius: 12px;
  position: relative;
  background: #eeeeee;
  isolation: isolate; /* Ensures blend mode works correctly */
}

/* Fix for mix-blend-mode in different contexts */
.product-loop__img-wrapper {
  isolation: isolate;
}

/* Ensure blend mode works in scroll gallery */
#scrollGalleryContainer {
  mix-blend-mode: multiply;
  isolation: isolate;
}

.product__image {
  mix-blend-mode: multiply;
}

/* Performance: Use GPU acceleration for hover transitions */
.hover-image,
.main-image {
  will-change: opacity;
}

.product-loop__img-wrapper:hover .hover-image,
.product-loop__img-wrapper:hover .main-image {
  will-change: auto; /* Remove after animation */
}

/* Ensure proper handling in carousel */
.flickity-slider .product-loop__img-wrapper .hover-image {
  pointer-events: none;
}

/* Placeholder styling */
.demo-1.box-ratio {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
}

.placeholder-svg {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Badge positioning */
.product-loop__badge-icon {
  z-index: 10;
  position: absolute;
}

.product-loop__badge-icon.icon-type--bestseller {
  background-color: #1d4ed8;
  border-radius: 8px;
  text-transform: uppercase;
  font-weight: 600;
  color: #fff;
}

/* Title consistency */
.p-title,
.p-title-index {
  min-height: 70px !important;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.p-title a,
.p-title-index a {
  font-size: 16px !important;
}

.price-index {
  font-size: 16px !important;
}

/* Mobile optimizations with preserved functionality */
@media screen and (max-width: 768px) {
  .template-index .product-loop__img-wrapper,
  .template-product .product-loop__img-wrapper {
    padding-bottom: 100%;
  }

  .template-index .product-loop__img-wrapper img,
  .template-product .product-loop__img-wrapper img {
    width: 90% !important; 
    height: 90% !important;
    object-fit: contain;
    mix-blend-mode: multiply; /* Preserved on mobile */
  }
  
  .template-index .hover-image img,
  .template-product .hover-image img {
    width: 90% !important;
    height: 90% !important;
    object-fit: contain;
    mix-blend-mode: multiply; /* Preserved on mobile */
  }

  .p-title,
  .p-title-index {
    min-height: 90px !important;
  }

  /* Badge spacing for mobile */
  .product-loop__badge-icon[data-badge-index="1"] {
    right: 66px !important;
  }
  .product-loop__badge-icon[data-badge-index="2"] {
    right: 122px !important;
  }
  .product-loop__badge-icon[data-badge-index="3"] {
    right: 178px !important;
  }
}

/* Tablet styling */
@media (min-width: 768px) and (max-width: 1024px) {
  .p-title,
  .p-title-index {
    min-height: 90px !important;
  }
  
  .p-title a,
  .p-title-index a {
    font-size: 16px !important;
  }
}

/* Disable hover on touch devices but keep blend mode */
@media (hover: none) and (pointer: coarse) {
  .product-loop__img-wrapper:hover .hover-image {
    opacity: 0;
    visibility: hidden;
  }
  
  .product-loop__img-wrapper:hover .main-image {
    opacity: 1;
  }
  
  .hover-image {
    display: none;
  }
  
  /* Ensure blend mode still works on touch */
  .product-loop__img-wrapper img {
    mix-blend-mode: multiply;
  }
}

/* Performance optimization: Reduce paint areas */
.product-loop__item {
  contain: layout style;
}

/* Fix for images not loading with proper blend mode */
img.loaded {
  mix-blend-mode: multiply;
}
</style>

{%- liquid
  assign date_range = settings.date_range
  assign badges = ''

  assign is_bestseller = false
  for tag in product.tags
    if tag == 'Hot'
      assign is_bestseller = true
      break
    endif
  endfor

  if is_bestseller
    assign badges = badges | append: 'bestseller:' | append: 'products.general.bestseller'
  endif

  if product.template_suffix == 'set'
    if badges != ''
      assign badges = badges | append: '|'
    endif
    assign badges = badges | append: 'new:' | append: 'products.general.set'
  elsif product.available
    assign product_created_at = product.created_at | date: '%s'
    assign time_ago = 'now' | date: '%s' | minus: product_created_at | divided_by: 86400

    assign is_on_sale = false
    if product.price < product.compare_at_price or product.price_min < product.compare_at_price_min or product.price_max < product.compare_at_price_max
      assign is_on_sale = true
    endif
    
    if is_on_sale
      if badges != ''
        assign badges = badges | append: '|'
      endif
      assign badges = badges | append: 'sale-item:' | append: 'products.general.sale'
    endif
    
    if product.template_suffix == 'pre-order'
      if badges != ''
        assign badges = badges | append: '|'
      endif
      assign badges = badges | append: 'pre-order:' | append: 'products.product.pre_order'
    endif
  else
    if badges != ''
      assign badges = badges | append: '|'
    endif
    assign badges = badges | append: 'sold-out:' | append: 'products.general.sold'
  endif

  assign badges_array = badges | split: '|'
  assign has_sale_badge = false
  for badge in badges_array
    if badge contains 'sale-item:'
      assign has_sale_badge = true
      break
    endif
  endfor

  if varying_grid == true and index == 3 or index == 4 or index == 13 or index == 14 or index == 23 or index == 24
    assign items_per_row = 'span-6 r-span-2 auto'
  elsif varying_grid == true
    assign items_per_row = 'span-3 r-span-1 auto'
  endif

  assign product_info_mobile_grid_left = 'sm-span-12'

  if varying_grid == true and index == 3 or index == 6 or index == 9 or index == 12 or index == 15 or index == 18
    assign items_per_row_mobile = 'sm-span-12 auto'
    assign product_info_mobile_grid_left = 'sm-span-9 a-left'
    assign product_info_mobile_grid_right = 'sm-span-3 a-right'
  elsif varying_grid == true
    assign items_per_row_mobile = 'sm-span-6 auto'
    assign product_info_mobile_grid_left = 'sm-span-12 a-left'
    assign product_info_mobile_grid_right = 'sm-span-12 a-right sm-a-left'
  endif
-%}

<article class="product-loop__item {{ carousel_slide }} {% unless carousel %}{{ items_per_row }} {{ items_per_row_mobile }}{% endunless %} relative product-loop__item--{{ settings.image_ratio }}"
  data-alpha="{{ product.title }}"
  data-price="{{ product.price }}">

  <div class="product-image relative">
    {% if badges != '' %}
      {% assign badge_count = 0 %}
      {% for badge in badges_array %}
        {% assign badge_parts = badge | split: ':' %}
        {% assign badge_type = badge_parts[0] %}
        {% assign badge_text = badge_parts[1] | t %}
        <div class="product-loop__badge-icon icon-type--{{ badge_type }} icn" style="right: {{ badge_count | times: 70 | plus: 10 }}px; top: 10px;" data-badge-index="{{ badge_count }}">{{ badge_text }}</div>
        {% assign badge_count = badge_count | plus: 1 %}
      {% endfor %}
    {% endif %}

    <div class="product-loop__img-wrapper relative">
      <a href="{{ product.url | within: collection }}" tabindex="-1" title="{{ product.title | escape }}" class="image-wrapper-link">
        {%- if product.media.size < 1 -%}
          <div class="demo-1 box-ratio" style="padding-bottom: 100%;">
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {%- else -%}
          {%- liquid
            assign sm_render = 'calc(100vw / 2)'
            assign md_render = 'calc(100vw / ' | append: grid_items | append: ')'
            assign lg_render = 'calc(1600px / ' | append: grid_items | append: ')'
            assign image = product.featured_media.preview_image
          -%}

          {%- if settings.product_grid_video -%}
            {% render 'product-loop-video', product: product %}
          {%- endif -%}

          <!-- Main image with optimized loading but preserving original structure -->
          {%- capture main_image_srcset -%}
            {{ image | image_url: width: 400 }} 400w,
            {{ image | image_url: width: 600 }} 600w,
            {{ image | image_url: width: 800 }} 800w,
            {{ image | image_url: width: 1000 }} 1000w
          {%- endcapture -%}

          <img 
            srcset="{{ main_image_srcset | strip }}"
            sizes="(max-width: 767px) 50vw, (max-width: 1023px) 33vw, 25vw"
            src="{{ image | image_url: width: 600 }}"
            alt="{{ product.title | escape }}"
            class="product-image--contain main-image"
            style="mix-blend-mode: multiply;"
            width="{{ image.width }}"
            height="{{ image.height }}"
            loading="{{ loading | default: 'lazy' }}"
            fetchpriority="{{ fetchpriority | default: 'auto' }}"
            decoding="async"
          >

          <!-- Hover image - keeping original functionality -->
          {% if product.media.size > 1 %}
            {%- liquid
              if product.media[1].media_type == 'image'
                assign hover_image = product.media[1]
              else
                assign hover_image = product.media[1].preview_image
              endif
            -%}
            
            {%- capture hover_image_srcset -%}
              {{ hover_image | image_url: width: 400 }} 400w,
              {{ hover_image | image_url: width: 600 }} 600w,
              {{ hover_image | image_url: width: 800 }} 800w,
              {{ hover_image | image_url: width: 1000 }} 1000w
            {%- endcapture -%}

            <div class="hover-image">
              <img 
                srcset="{{ hover_image_srcset | strip }}"
                sizes="(max-width: 767px) 50vw, (max-width: 1023px) 33vw, 25vw"
                src="{{ hover_image | image_url: width: 600 }}"
                alt="{{ product.title | append: ' - ' | append: hover_image.alt | default: product.title | escape }}"
                class="product-image--contain"
                style="mix-blend-mode: multiply;"
                width="{{ hover_image.width }}"
                height="{{ hover_image.height }}"
                loading="lazy"
                decoding="async"
              >
            </div>
          {% endif %}
        {%- endif -%}
      </a>
    </div>

    {%- liquid
      if routes.root_url == '/'
        assign product_url = '/products/' | append: product.handle | append: '?section_id=quickshop'
      else
        assign product_url = routes.root_url | append: '/products/' | append: product.handle | append: '?section_id=quickshop'
      endif

      assign has_model = false
      assign has_video = false
      for media in product.media
        if media.media_type == "video" or media.media_type == "external_video"
          assign has_video = true
          continue
        endif
        if media.media_type == "model"
          assign has_model = true
          continue
        endif
      endfor
    -%}

    {% comment %} Quick Add Button {% endcomment %}
    {% comment %} 
    Quick Add Button section remains commented out as in original
    {% endcomment %}
  </div>

  <div class="grid__wrapper edge pt2 cg0 sm-cg0 rg0 name-wrapper">
    <div class="product-loop__info-wrapper span-12 {{ product_info_mobile_grid_left }} auto">
      {% if settings.product_grid_vendor %}
        <p class="product-loop__vendor block mb2">{{ product.vendor }}</p>
      {% endif %}
      
      <p class="product-loop__title p-title p-title-index">
        <a class="text-base" href="{{ product.url | within: collection }}">{{ product.title }}</a>
      </p>
    </div>

    {%- if product.template_suffix == 'set' -%}
      <div class="product-loop__price span-4 {{ product_info_mobile_grid_right }} auto">
        {{ 'products.product.price_varies' | t }}
      </div>
    {%- else -%}
      <div class="product-loop__price text-sm lg:text-base font-medium {{ product_info_mobile_grid_right }} {% unless is_mobile_search %}price-index{% endunless %}">
        {% if product.price < product.compare_at_price %}
          Od
          <span class="product-loop__price--sale onsale inline-block text-base font-bold {% unless is_mobile_search %}price-index{% endunless %}">
            {{ product.price | money }}
          </span>
          <span class="product-loop__price--compare was inline-block ml1 text-base font-bold {% unless is_mobile_search %}price-index{% endunless %}">
            {{ product.compare_at_price | money }}
          </span>
          {% assign savings = product.compare_at_price | minus: product.price %}
          <span class="product-loop__price--savings savings hide">
            ({{ 'collections.general.save' | t }} {{ savings | money }})
          </span>
        {% else %}
          {% if product.price_varies %}
            Od {{ product.price_min | money }}
          {% else %}
            {{ product.price | money }}
          {% endif %}
        {% endif %}

        {%- render 'product-unit-price', variant: product.selected_or_first_available_variant -%}
      </div>
    {%- endif -%}
  </div>
 
  {% if settings.show_collection_swatches %}
    <div class="product-loop__color-swatches">
      {% render 'snip-product-loop-swatches',
        product: product,
        color_swatch_style: settings.color_swatch_style %}
    </div>
  {% endif %}

  {% if settings.show_collection_sizes %}
    <div class="product-loop__sizes">
      {% render 'snip-product-loop-sizes',
        product: product %}
    </div>
  {% endif %}

</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Fix for mix-blend-mode with lazy loaded images
  function ensureBlendMode() {
    const productImages = document.querySelectorAll('.product-loop__img-wrapper img');
    
    productImages.forEach(img => {
      // Ensure blend mode is applied after image loads
      if (img.complete) {
        img.style.mixBlendMode = 'multiply';
      } else {
        img.addEventListener('load', function() {
          this.style.mixBlendMode = 'multiply';
        });
      }
      
      // Fix for Safari
      if (navigator.userAgent.indexOf('Safari') != -1 && navigator.userAgent.indexOf('Chrome') == -1) {
        img.style.isolation = 'isolate';
        setTimeout(() => {
          img.style.mixBlendMode = 'multiply';
        }, 100);
      }
    });
  }
  
  // Apply blend mode fix
  ensureBlendMode();
  
  // Preserve hover functionality
  function preserveHoverEffect() {
    const wrappers = document.querySelectorAll('.product-loop__img-wrapper');
    
    wrappers.forEach(wrapper => {
      const mainImage = wrapper.querySelector('.main-image');
      const hoverImage = wrapper.querySelector('.hover-image');
      
      if (mainImage && hoverImage) {
        // Ensure smooth transitions
        mainImage.style.transition = 'opacity 0.3s ease';
        hoverImage.style.transition = 'opacity 0.3s ease, visibility 0.3s ease';
        
        // Desktop hover
        if (window.matchMedia('(hover: hover)').matches) {
          wrapper.addEventListener('mouseenter', function() {
            hoverImage.style.opacity = '1';
            hoverImage.style.visibility = 'visible';
            mainImage.style.opacity = '0';
          });
          
          wrapper.addEventListener('mouseleave', function() {
            hoverImage.style.opacity = '0';
            hoverImage.style.visibility = 'hidden';
            mainImage.style.opacity = '1';
          });
        }
      }
    });
  }
  
  preserveHoverEffect();
  
  // Reapply on dynamic content load (for infinite scroll, filters, etc.)
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes.length) {
        ensureBlendMode();
        preserveHoverEffect();
      }
    });
  });
  
  // Observe product grid for changes
  const productGrid = document.querySelector('.collection__products, .search__products');
  if (productGrid) {
    observer.observe(productGrid, { childList: true, subtree: true });
  }
  
  // Performance: Preload hover images on desktop
  if (window.matchMedia('(hover: hover)').matches) {
    setTimeout(() => {
      const hoverImages = document.querySelectorAll('.hover-image img[loading="lazy"]');
      hoverImages.forEach(img => {
        if (img.dataset.src) {
          img.src = img.dataset.src;
        }
      });
    }, 2000); // Delay to prioritize main images
  }
  
  // Prevent layout shift without altering the image aspect ratio
  function preventImageShift() {
    // Only add this on mobile where layout shift is most problematic
    if (window.innerWidth <= 768) {
      const articleWrappers = document.querySelectorAll('.product-loop__img-wrapper');
      articleWrappers.forEach(wrapper => {
        // Ensure consistent placeholder until image loads
        const img = wrapper.querySelector('img');
        if (img) {
          // Add loading attribute for better loading behavior
          if (!img.hasAttribute('loading')) {
            img.setAttribute('loading', 'lazy');
          }
          
          // We're monitoring for load but not changing image dimensions
          img.addEventListener('load', function() {
            wrapper.classList.add('image-loaded');
          });
        }
      });
    }
  }
  
  preventImageShift();
  
  // Run again on window resize
  window.addEventListener('resize', preventImageShift);
});
</script>