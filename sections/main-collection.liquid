<style>
/* CRITICAL: Load immediately to prevent layout shift */
.desc p, .rte.desc p { font-size: 16px !important; margin-top: 6px !important; margin-bottom: 0 !important; transition: none !important; animation: none !important; }
.desc h3, .rte.desc h3, { font-size: 16px !important; font-weight: 700 !important; margin: 0 !important; transition: none !important; animation: none !important; }
@media (max-width: 1024px) { .desc p, .rte.desc p { font-size: 14px !important; } .desc h3, .rte.desc h3 { font-size: 14px !important; } }
</style>

{% comment %} Collection Page Assets {% endcomment %}
<link rel="preload" href="{{ 'section-main-collection.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ 'section-main-collection.css' | asset_url }}"></noscript>
<link rel="preload" href="{{ 'component-product-grid.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ 'component-product-grid.css' | asset_url }}"></noscript>

{% comment %} Collection Page Logic {% endcomment %}
{%- liquid
  assign page_limit = section.settings.items_per_page

  assign has_sortby = false
  for block in section.blocks
    if block.type == 'sort_by'
      assign has_sortby = true
    endif
  endfor

  assign has_filter = false
  for block in section.blocks
    if block.type == 'filter'
      assign has_filter = true
    endif
  endfor

  assign filter_count = 0
  for filter in collection.filters
    if filter.type == 'price_range'
      if filter.min_value.value != nil or filter.max_value.value != nil
        assign filter_count = filter_count | plus: 1
      endif
    endif
    assign filter_count = filter_count | plus: filter.active_values.size
  endfor

  if section.settings.collection_image and collection.image
    assign collection_image = true
    assign header_width = 'span-8'
  else
    assign collection_image = false
    assign header_width = 'span-8 push-2'
  endif

  assign empty_collection = true
  if collection.products.size > 0
    assign empty_collection = false
  endif

  case section.settings.items_per_row
  when 4
    assign items_per_row = 'span-3 sm-span-6 auto'
  when 3
    assign items_per_row = 'span-4 sm-span-6 auto'
  when 2
    assign items_per_row = 'span-6 sm-span-6 auto'
  when 1
    assign items_per_row = 'span-12 sm-span-12'
  endcase

  if settings.varying_grid
    assign grid_type = 'reverse cg6 sm-cg4 rg6 sm-rg6'
  else
    assign grid_type = 'cg6 sm-cg4 rg9 sm-rg6'
  endif
-%}

{% comment %} Enhanced Modern Collection Page Template {% endcomment %}
<section
  id="collection-page"
  class="collection__page--wrapper collection-template collection-{{ section.id }} modern-collection-filters mt6 pb9 no-section-animation"
  data-section-id="{{ section.id }}"
  data-section-type="collection"
  data-asset-url="{{ 'section-main-collection.js' | asset_url }}"
  data-collection-handle="{{ collection.handle }}"
  data-empty="{{ empty_collection }}">

  {% paginate collection.products by page_limit %}
    <div id="CollectionProductGrid" class="grid__wrapper px-3 lg:px-0">
      
      {%- comment -%} Collection Header {%- endcomment -%}
      {%- if collection.description != blank -%}
        <div class="collection__page--description w-100 span-8 mt2 pb2 a-left">
          <div class="rte desc">
            <h1 class="text-2xl font-bold">
              {{ collection.title }}
            </h1>
            <p>
              {{ collection.description | replace: '<span>', '<span class=" text-base">' }}
            </p>
          </div>
        </div>
      {%- endif -%}

      {%- if collection_image -%}
       <div class="collection__page--image span-4 auto">
         {% liquid
           if section.index == 1
             assign loading = 'eager'
             assign fetch_priority = 'high'
           endif
          %}
         {% render 'helper-image',
            type: collection.image,
            sm_render: '100vw'
            md_render: 'calc((100vw / 12) * 4)',
            lg_render: 'calc((1600px / 12) * 4)',
            loading: loading,
            fetchpriority: fetch_priority %}
       </div>
     {%- endif -%}

     {%- comment -%} Enhanced Filter Top Bar {%- endcomment -%}
     {%- liquid
       assign show_filters = false
       if collection.filters.size > 0 or has_sortby
         assign show_filters = true
       endif
     -%}
     
     {% if show_filters %}
       <div class="modern-filter-topbar span-12 auto">
         <button class="modern-filter-button" 
                 type="button" 
                 onclick="FilterDrawer.open()"
                 aria-label="{{ 'collections.filter.filter' | t | default: 'Otwórz filtry' }}">
           {{ 'collections.filter.filter' | t | default: 'Filtruj' }}
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
             <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"></polygon>
           </svg>
         </button>
         <div class="modern-product-count">
           <span id="modernProductCount">
             {%- if collection.products_count == 1 -%}
               {{ collection.products_count }} produkt
             {%- elsif collection.products_count < 5 -%}
               {{ collection.products_count }} produkty
             {%- else -%}
               {{ collection.products_count }} produktów
             {%- endif -%}
           </span>
         </div>
       </div>
     {% endif %}

     {%- comment -%} Enhanced Current Filters Display {%- endcomment -%}
     {%- comment -%} Enhanced Current Filters Display with Mobile Support {%- endcomment -%}
{% comment %} <div class="modern-current-filters span-12 auto" id="modernCurrentFilters" {% unless filter_count > 0 %}style="display: none;"{% endunless %}>
  <div class="modern-current-filters-wrapper">
   
    <div class="modern-current-filters-header">
      <h3 class="modern-current-filters-title">{{ 'collections.filter.filtering_by_label' | t | default: 'Bieżące filtry:' }}</h3>
  
      <div class="modern-clear-all-mobile" style="display: none;">
        {% if filter_count > 0 %}
          <button class="modern-clear-all-filters" 
                  type="button" 
                  onclick="FilterDrawer.clearAll()"
                  aria-label="{{ 'collections.filter.clear_all' | t | default: 'Wyczyść wszystkie filtry' }}">
            <span class="clear-all-text">{{ 'collections.filter.clear_all' | t | default: 'Wyczyść' }}</span>
          </button>
        {% endif %}
      </div>
    </div>
    

    <div class="modern-current-filters-scroll-container">
      <ul class="modern-current-filters-list" id="modernCurrentFiltersList">
     
        {% for filter in collection.filters %}
          {% for value in filter.active_values %}
            <li class="modern-current-filter-item">
              <button class="modern-current-filter-tag" 
                      type="button"
                      data-filter-param="{{ value.param_name }}"
                      data-filter-value="{{ value.value }}"
                      onclick="FilterDrawer.removeFilter('{{ value.param_name }}', '{{ value.value }}')"
                      aria-label="{{ 'collections.filter.remove_filter' | t | default: 'Usuń filtr' }} {{ value.label | escape }}">
                <span class="filter-tag-text">{{ value.label | escape }}</span>
                <span class="modern-filter-remove-icon" aria-hidden="true">×</span>
              </button>
            </li>
          {% endfor %}
          {% if filter.type == 'price_range' %}
            {% if filter.min_value.value != nil %}
              <li class="modern-current-filter-item">
                <button class="modern-current-filter-tag" 
                        type="button"
                        data-filter-param="filter.v.price.gte"
                        data-filter-value="{{ filter.min_value.value }}"
                        onclick="FilterDrawer.removeFilter('filter.v.price.gte', '{{ filter.min_value.value }}')"
                        aria-label="{{ 'collections.filter.remove_filter' | t | default: 'Usuń filtr' }} ceny minimalnej">
                  <span class="filter-tag-text">Od {{ filter.min_value.value | money_without_currency | replace: ',', '' | round }} zł</span>
                  <span class="modern-filter-remove-icon" aria-hidden="true">×</span>
                </button>
              </li>
            {% endif %}
            {% if filter.max_value.value != nil %}
              <li class="modern-current-filter-item">
                <button class="modern-current-filter-tag" 
                        type="button"
                        data-filter-param="filter.v.price.lte"
                        data-filter-value="{{ filter.max_value.value }}"
                        onclick="FilterDrawer.removeFilter('filter.v.price.lte', '{{ filter.max_value.value }}')"
                        aria-label="{{ 'collections.filter.remove_filter' | t | default: 'Usuń filtr' }} ceny maksymalnej">
                  <span class="filter-tag-text">Do {{ filter.max_value.value | money_without_currency | replace: ',', '' | round }} zł</span>
                  <span class="modern-filter-remove-icon" aria-hidden="true">×</span>
                </button>
              </li>
            {% endif %}
          {% endif %}
        {% endfor %}
        

        {% if filter_count > 0 %}
          <li class="modern-current-filter-item modern-clear-all-desktop">
            <button class="modern-clear-all-filters" 
                    type="button" 
                    onclick="FilterDrawer.clearAll()"
                    aria-label="{{ 'collections.filter.clear_all' | t | default: 'Wyczyść wszystkie filtry' }}">
              <span class="clear-all-text">{{ 'collections.filter.clear_all' | t | default: 'Wyczyść wszystkie' }}</span>
            </button>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</div> {% endcomment %}

      {%- if collection.products.size >= 1 -%}
        <div class="collection span-12 " id="main-collection-product-grid" data-id="{{ section.id }}">
          <div class="product-loop grid__wrapper  {{ grid_type }} edge">
            {% if collection != blank %}
              {% for product in collection.products limit: page_limit %}
                {% liquid
                  assign loading = 'lazy'
                  assign fetch_priority = 'auto'
                  if section.index == 1
                    if settings.varying_grid and forloop.index <= 3
                      assign loading = 'eager'
                      assign fetch_priority = 'high'
                    elsif forloop.index <= section.settings.items_per_row
                      assign loading = 'eager'
                      assign fetch_priority = 'high'
                    endif
                  endif
                 %}
                {% render 'product-loop',
                  collection: collection,
                  product: product,
                  grid_items: section.settings.items_per_row,
                  product_info_align: 'a-center',
                  items_per_row: items_per_row,
                  varying_grid: settings.varying_grid,
                  index: forloop.index,
                  loading: loading,
                  fetchpriority: fetch_priority %}
              {% endfor %}
              <div class="span-12 auto">
              {% unless collection.products_count <= page_limit %}
                {% render 'snip-pagination', paginate: paginate %}
              {% endunless %}
              </div>
            {% else %}
              {% for i in (1..3) %}
                {% capture current %}{% cycle 1, 2, 3, 4, 5, 6 %}{% endcapture %}
                {% assign placeholder = 'product-' | append: current %}
                <article class="product-listing relative {{ settings.image_ratio }} a-center">
                  <div class="product-image">
                    <div class="reveal relative demo-1 ">
                      {{ placeholder | placeholder_svg_tag: 'placeholder-svg' }}
                    </div>
                  </div>
                  <div class="product-info mt1 pb1 px1 sm-px0 a-center">
                    <small class="product-vendor block mb1">Product Vendor</small>
                    <p class="product-title">Product Title</p>
                    <p class="product-subtitle mb0">Product subtitle</p>
                  </div>
                </article>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      {%- else -%}
        <div class="collection collection--empty span-12 relative" id="main-collection-product-grid" data-id="{{ section.id }}">
          <div class="js-coll-empty-filter py10 a-center" style="display: none;">
            <h2>{{ 'collections.filter.no_results' | t }}</h2>
            <p>{{ 'collections.filter.use_fewer_filters' | t }}</p>
            <button class="button btn-outlined" type="button" onclick="FilterDrawer.clearAll()">{{ 'collections.filter.clear_all' | t }}</button>
          </div>
          <div class="js-coll-empty py10 a-center no-js-show">
            <h2>{{ 'collections.general.empty' | t }}</h2>
            <p>{{ 'collections.general.no_matches' | t }}</p>
            <a class="button btn-outlined" href="{{ routes.collections_url }}">{{ 'collections.general.all_collections' | t }}</a>
          </div>
        </div>
      {%- endif -%}
   </div>
   {% endpaginate %}
</section>

<!-- BULLETPROOF FILTER DRAWER SYSTEM - Built from Scratch -->
{% if show_filters %}
  <!-- Drawer Container - Always at body level -->
  <div id="filterDrawerContainer" class="filter-drawer-container">
    
    <!-- Backdrop Overlay -->
    <div id="filterBackdrop" class="filter-backdrop" onclick="FilterDrawer.close()"></div>
    
    <!-- The Actual Drawer -->
    <div id="filterDrawer" class="filter-drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      
      <!-- Fixed Header -->
      <div class="filter-drawer-header">
        <h2 id="drawerTitle" class="filter-drawer-title">
          {{ 'collections.filter.filter_and_sort' | t | default: 'Filtrowanie i sortowanie' }}
        </h2>
        <button class="filter-drawer-close" onclick="FilterDrawer.close()" type="button" aria-label="Zamknij filtry">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <!-- Scrollable Content -->
      <div class="filter-drawer-content">
        
        <!-- Sort Section -->
        {% if has_sortby %}
          <div class="filter-section">
            <button class="filter-section-header" onclick="FilterDrawer.toggleSection('sort')" type="button">
              <span>{{ 'collections.filter.sort_title' | t | default: 'Sortuj' }}</span>
              <svg class="filter-section-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"></polyline>
              </svg>
            </button>
            <div class="filter-section-content" id="filterSectionSort">
              <div class="filter-options">
                {% for option in collection.sort_options %}
                  <label class="filter-option-item sort-option" data-sort-value="{{ option.value }}">
                    <input type="radio" 
                           name="sort_by" 
                           value="{{ option.value }}" 
                           {% if option.value == collection.sort_by %}checked{% endif %}
                           onchange="FilterDrawer.handleSort('{{ option.value }}')">
                    <span class="filter-option-label">{{ option.name }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Filter Sections -->
        {% if has_filter and collection.filters.size > 0 %}
          {% for filter in collection.filters %}
            {% case filter.type %}
              {% when 'list' %}
                <div class="filter-section">
                  <button class="filter-section-header" onclick="FilterDrawer.toggleSection('{{ filter.label | handle }}')" type="button">
                    <span>{{ filter.label | escape }}</span>
                    <svg class="filter-section-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6,9 12,15 18,9"></polyline>
                    </svg>
                  </button>
                  <div class="filter-section-content" id="filterSection{{ filter.label | handle | capitalize }}">
                    <div class="filter-options">
                      {% assign sorted_values = filter.values | sort: 'count' | reverse %}
                      {% for value in sorted_values %}
                        <label class="filter-option-item {% if value.active %}active{% endif %}" 
                               {% if value.count == 0 and value.active == false %}data-disabled="true"{% endif %}>
                          <input type="checkbox"
                                 name="{{ value.param_name }}"
                                 value="{{ value.value }}"
                                 data-param="{{ value.param_name }}"
                                 data-value="{{ value.value }}"
                                 data-label="{{ value.label | escape }}"
                                 {% if value.active %}checked{% endif %}
                                 {% if value.count == 0 and value.active == false %}disabled{% endif %}
                                 onchange="FilterDrawer.handleFilterChange(this)">
                          <span class="filter-option-checkbox"></span>
                          <span class="filter-option-label">{{ value.label | escape }}</span>
                          <span class="filter-option-count">({{ value.count }})</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% when 'price_range' %}
                <div class="filter-section">
                  <button class="filter-section-header" onclick="FilterDrawer.toggleSection('price')" type="button">
                    <span>{{ filter.label | escape }}</span>
                    <svg class="filter-section-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6,9 12,15 18,9"></polyline>
                    </svg>
                  </button>
                  <div class="filter-section-content" id="filterSectionPrice">
                    <div class="price-range-inputs">
                      <div class="price-input-group">
                        <label for="priceMin">{{ 'collections.filter.from' | t | default: 'Od' }}</label>
                        <input type="number" 
                               id="priceMin" 
                               placeholder="0"
                               min="0"
                               max="{{ filter.range_max | money_without_currency | replace: ',', '' | round }}"
                               value="{% if filter.min_value.value %}{{ filter.min_value.value | money_without_currency | replace: ',', '' | round }}{% endif %}">
                      </div>
                      <div class="price-input-group">
                        <label for="priceMax">{{ 'collections.filter.to' | t | default: 'Do' }}</label>
                        <input type="number" 
                               id="priceMax" 
                               placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' | round }}"
                               min="0"
                               max="{{ filter.range_max | money_without_currency | replace: ',', '' | round }}"
                               value="{% if filter.max_value.value %}{{ filter.max_value.value | money_without_currency | replace: ',', '' | round }}{% endif %}">
                      </div>
                    </div>
                    <button type="button" class="price-apply-btn" onclick="FilterDrawer.applyPriceFilter()">
                      {{ 'collections.filter.apply' | t | default: 'Zastosuj' }}
                    </button>
                  </div>
                </div>
            {% endcase %}
          {% endfor %}
        {% endif %}
      </div>
      
      <!-- Fixed Footer -->
      <div class="filter-drawer-footer">
        <button class="filter-apply-btn" onclick="FilterDrawer.close()" type="button">
          <span id="filterApplyText">{{ 'collections.filter.view_results' | t | default: 'Zobacz wyniki' }}</span>
        </button>
      </div>
    </div>
  </div>
{% endif %}

<script>

  
// BULLETPROOF FILTER DRAWER SYSTEM - Built from Scratch
const FilterDrawer = {
  isOpen: false,
  isLoading: false,
  activeFilters: {
    sort: '{{ collection.sort_by | default: "manual" }}',
    filters: {}
  },
  
  init() {
    console.log('🚀 FilterDrawer System Started');
    this.loadFiltersFromURL();
    this.loadExistingFilters();
    this.setupEventListeners();
    this.createBodyContainer();
    this.disableThemeFilters();
    
    // Initialize drawer state to reflect current filters
    setTimeout(() => {
      this.updateDrawerState();
    }, 200);
    
    console.log('✅ FilterDrawer System Ready');
  },
  
  // Safely disable existing theme filter system to prevent conflicts
  disableThemeFilters() {
    // Hide existing theme filter buttons (but NOT product elements)
    const themeFilterButtons = document.querySelectorAll('[data-wau-slideout-target="collection-filters"]:not(.modern-filter-button)');
    themeFilterButtons.forEach(btn => {
      btn.style.display = 'none';
    });
    
    // Hide original collection filtering elements (but NOT product containers)
    const selectors = [
      '.slideout__trigger-filters:not(.modern-filter-button)',
      '.slideout[data-wau-slideout="collection-filters"]:not(#filterDrawerContainer *)',
      '.filter-drawer__filtering__results:not(.modern-current-filters)',
      '.collection__page--topbar .button:not(.modern-filter-button)',
      '.collection__horizontal-toolbar .slideout__trigger-filters:not(.modern-filter-button)'
    ];
    
    selectors.forEach(selector => {
      try {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          // Only hide if it's not within a product container
          if (!el.closest('.product-listing, .product-item, .product-loop, .grid__wrapper .span-3, .grid__wrapper .span-4, .grid__wrapper .span-6')) {
            el.style.display = 'none';
            el.style.visibility = 'hidden';
            el.style.opacity = '0';
            el.style.pointerEvents = 'none';
          }
        });
      } catch (e) {
        console.warn('Could not hide selector:', selector, e);
      }
    });
    
    // Disable WAU slideout for collection-filters only
    if (window.WAU && window.WAU.Slideout) {
      const originalInit = window.WAU.Slideout.init;
      window.WAU.Slideout.init = function(target) {
        if (target === 'collection-filters') {
          console.log('🚫 Blocked WAU slideout init for collection-filters');
          return;
        }
        return originalInit.call(this, target);
      };
    }
  },
  
  // Create container at body level for proper positioning
  createBodyContainer() {
    const container = document.getElementById('filterDrawerContainer');
    if (container && !container.parentElement.matches('body')) {
      document.body.appendChild(container);
      console.log('✅ Drawer moved to body level');
    }
  },
  
  setupEventListeners() {
    // Escape key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.isOpen) {
        this.close();
      }
    });
    
    // Prevent body scroll when drawer is open
    document.addEventListener('touchmove', (e) => {
      if (this.isOpen && !e.target.closest('.filter-drawer')) {
        e.preventDefault();
      }
    }, { passive: false });
  },
  
  // BULLETPROOF OPEN - Works from any scroll position
  open() {
    if (this.isLoading) return;
    
    const container = document.getElementById('filterDrawerContainer');
    const backdrop = document.getElementById('filterBackdrop');
    const drawer = document.getElementById('filterDrawer');
    
    if (!container || !backdrop || !drawer) {
      console.error('❌ Drawer elements not found');
      return;
    }
    
    // Ensure container is at body level
    if (!container.parentElement.matches('body')) {
      document.body.appendChild(container);
    }
    
    // Update drawer state before opening to reflect current filters
    this.updateDrawerState();
    
    // Store current scroll position
    this.scrollPosition = window.pageYOffset;
    
    // Show with bulletproof method
    container.style.display = 'block';
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100vw';
    container.style.height = '100vh';
    container.style.zIndex = '999999';
    
    // Trigger animations
    requestAnimationFrame(() => {
      backdrop.classList.add('active');
      drawer.classList.add('active');
    });
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${this.scrollPosition}px`;
    document.body.style.width = '100%';
    
    this.isOpen = true;
    
    // Focus management
    setTimeout(() => {
      const firstFocusable = drawer.querySelector('button, input');
      if (firstFocusable) firstFocusable.focus();
    }, 100);
    
    console.log('✅ Drawer opened successfully');
  },
  
  // BULLETPROOF CLOSE - Restores scroll position
  close() {
    const container = document.getElementById('filterDrawerContainer');
    const backdrop = document.getElementById('filterBackdrop');
    const drawer = document.getElementById('filterDrawer');
    
    if (!container || !backdrop || !drawer) return;
    
    // Remove active classes for animation
    backdrop.classList.remove('active');
    drawer.classList.remove('active');
    
    // Hide after animation
    setTimeout(() => {
      container.style.display = 'none';
    }, 300);
    
    // Restore body scroll and position
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    
    // Restore scroll position
    if (this.scrollPosition !== undefined) {
      window.scrollTo(0, this.scrollPosition);
    }
    
    this.isOpen = false;
    
    // Return focus to filter button
    const filterButton = document.querySelector('.modern-filter-button');
    if (filterButton) filterButton.focus();
    
    console.log('✅ Drawer closed successfully');
  },
  
  toggleSection(sectionId) {
    const content = document.getElementById(`filterSection${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
    const header = event.target.closest('.filter-section-header');
    const arrow = header?.querySelector('.filter-section-arrow');
    
    if (!content || !header || !arrow) return;
    
    const isOpen = content.classList.contains('active');
    
    if (isOpen) {
      content.classList.remove('active');
      arrow.classList.remove('rotated');
      content.style.maxHeight = '0';
    } else {
      content.classList.add('active');
      arrow.classList.add('rotated');
      content.style.maxHeight = content.scrollHeight + 'px';
    }
  },
  
  handleSort(sortValue) {
    this.activeFilters.sort = sortValue;
    this.applyFilters();
  },
  
  handleFilterChange(checkbox) {
    const param = checkbox.dataset.param;
    const value = checkbox.dataset.value;
    const label = checkbox.dataset.label;
    const filterItem = checkbox.closest('.filter-option-item');
    
    if (!this.activeFilters.filters[param]) {
      this.activeFilters.filters[param] = [];
    }
    
    if (checkbox.checked) {
      if (!this.activeFilters.filters[param].includes(value)) {
        this.activeFilters.filters[param].push(value);
        this.addFilterTag(param, value, label);
        // Add active class to the filter item
        if (filterItem) {
          filterItem.classList.add('active');
        }
      }
    } else {
      const index = this.activeFilters.filters[param].indexOf(value);
      if (index > -1) {
        this.activeFilters.filters[param].splice(index, 1);
        if (this.activeFilters.filters[param].length === 0) {
          delete this.activeFilters.filters[param];
        }
        this.removeFilterTag(param, value);
        // Remove active class from the filter item
        if (filterItem) {
          filterItem.classList.remove('active');
        }
      }
    }
    
    this.applyFilters();
  },
  
  applyPriceFilter() {
    const minInput = document.getElementById('priceMin');
    const maxInput = document.getElementById('priceMax');
    
    if (!minInput || !maxInput) return;
    
    const minValue = parseInt(minInput.value) || 0;
    const maxValue = parseInt(maxInput.value) || 0;
    
    // Remove existing price filters
    Object.keys(this.activeFilters.filters).forEach(key => {
      if (key.includes('price')) {
        this.removeFilterTag(key, this.activeFilters.filters[key][0]);
        delete this.activeFilters.filters[key];
      }
    });
    
    // Add new price filters
    if (minValue > 0) {
      this.activeFilters.filters['filter.v.price.gte'] = [minValue * 100];
      this.addFilterTag('filter.v.price.gte', minValue * 100, `Od ${minValue} zł`);
    }
    
    if (maxValue > 0) {
      this.activeFilters.filters['filter.v.price.lte'] = [maxValue * 100];
      this.addFilterTag('filter.v.price.lte', maxValue * 100, `Do ${maxValue} zł`);
    }
    
    this.applyFilters();
  },
  
  removeFilter(param, value) {
    if (this.activeFilters.filters[param]) {
      const index = this.activeFilters.filters[param].indexOf(value);
      if (index > -1) {
        this.activeFilters.filters[param].splice(index, 1);
        if (this.activeFilters.filters[param].length === 0) {
          delete this.activeFilters.filters[param];
        }
      }
    }
    
    this.removeFilterTag(param, value);
    this.updateDrawerState();
    this.applyFilters();
  },
  
  clearAll() {
    this.activeFilters.filters = {};
    this.activeFilters.sort = 'manual';
    
    // Clear all filter tags
    const list = document.getElementById('modernCurrentFiltersList');
    if (list) list.innerHTML = '';
    
    // Hide filter container
    const container = document.getElementById('modernCurrentFilters');
    if (container) container.style.display = 'none';
    
    // Update drawer
    this.updateDrawerState();
    
    // Navigate to clean URL
    const url = new URL(window.location.href);
    url.search = '';
    window.location.href = url.toString();
  },
  
  addFilterTag(param, value, label) {
    const container = document.getElementById('modernCurrentFilters');
    const list = document.getElementById('modernCurrentFiltersList');
    
    if (!list || !container) return;
    
    // Check if already exists
    if (list.querySelector(`[data-filter-param="${param}"][data-filter-value="${value}"]`)) return;
    
    const li = document.createElement('li');
    li.className = 'modern-current-filter-item';
    li.innerHTML = `
      <button class="modern-current-filter-tag" 
              type="button"
              data-filter-param="${param}"
              data-filter-value="${value}"
              onclick="FilterDrawer.removeFilter('${param}', '${value}')"
              aria-label="Usuń filtr ${label}">
        <span class="filter-tag-text">${label}</span>
        <span class="modern-filter-remove-icon" aria-hidden="true">×</span>
      </button>
    `;
    
    list.appendChild(li);
    container.style.display = 'block';
    
    // Add clear all button if needed
    if (!list.querySelector('.modern-clear-all-filters')) {
      const clearLi = document.createElement('li');
      clearLi.className = 'modern-current-filter-item';
      clearLi.innerHTML = `
        <button class="modern-clear-all-filters" 
                type="button" 
                onclick="FilterDrawer.clearAll()"
                aria-label="Wyczyść wszystkie filtry">
          <span class="clear-all-text">Wyczyść wszystkie</span>
        </button>
      `;
      list.appendChild(clearLi);
    }
  },
  
  removeFilterTag(param, value) {
    const list = document.getElementById('modernCurrentFiltersList');
    if (!list) return;
    
    const tag = list.querySelector(`[data-filter-param="${param}"][data-filter-value="${value}"]`);
    if (tag) {
      const li = tag.closest('.modern-current-filter-item');
      if (li) li.remove();
    }
    
    // Hide container if no more filters
    const remainingTags = list.querySelectorAll('.modern-current-filter-tag');
    if (remainingTags.length === 0) {
      const container = document.getElementById('modernCurrentFilters');
      if (container) container.style.display = 'none';
    }
  },
  
  updateDrawerState() {
    // Update checkboxes and labels to match active filters
    document.querySelectorAll('#filterDrawer .filter-option-item').forEach(filterItem => {
      const checkbox = filterItem.querySelector('input[type="checkbox"]');
      if (!checkbox) return;
      
      const param = checkbox.dataset.param;
      const value = checkbox.dataset.value;
      
      // Check if this filter is active
      const isActive = this.activeFilters.filters[param] && 
                      this.activeFilters.filters[param].includes(value);
      
      // Update checkbox state
      checkbox.checked = isActive;
      
      // Update visual state
      if (isActive) {
        filterItem.classList.add('active');
      } else {
        filterItem.classList.remove('active');
      }
    });
    
    // Update sort radio buttons
    document.querySelectorAll('#filterDrawer .sort-option input[type="radio"]').forEach(radio => {
      radio.checked = radio.value === this.activeFilters.sort;
    });
    
    // Update apply button text
    const applyBtn = document.getElementById('filterApplyText');
    if (applyBtn) {
      const filterCount = Object.keys(this.activeFilters.filters).length;
      if (filterCount > 0) {
        applyBtn.textContent = `Zobacz wyniki`;
      } else {
        applyBtn.textContent = 'Zobacz wyniki';
      }
    }
    
    console.log('🔄 Drawer state updated. Active filters:', this.activeFilters.filters);
  },
  
  loadFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Load sort
    const sortBy = urlParams.get('sort_by');
    if (sortBy) {
      this.activeFilters.sort = sortBy;
    }
    
    // Load filters
    urlParams.forEach((value, key) => {
      if (key.startsWith('filter.')) {
        if (!this.activeFilters.filters[key]) {
          this.activeFilters.filters[key] = [];
        }
        this.activeFilters.filters[key].push(value);
      }
    });
  },
  
  loadExistingFilters() {
    // Load from existing filter tags in DOM
    const existingTags = document.querySelectorAll('.modern-current-filter-tag[data-filter-param]');
    existingTags.forEach(tag => {
      const param = tag.getAttribute('data-filter-param');
      const value = tag.getAttribute('data-filter-value');
      if (param && value) {
        if (!this.activeFilters.filters[param]) {
          this.activeFilters.filters[param] = [];
        }
        if (!this.activeFilters.filters[param].includes(value)) {
          this.activeFilters.filters[param].push(value);
        }
      }
    });
  },
  
  applyFilters() {
    if (this.isLoading) return;
    this.isLoading = true;
    
    // Build URL
    const url = new URL(window.location.href);
    url.search = '';
    
    // Add sort
    if (this.activeFilters.sort !== 'manual') {
      url.searchParams.set('sort_by', this.activeFilters.sort);
    }
    
    // Add filters
    Object.keys(this.activeFilters.filters).forEach(param => {
      this.activeFilters.filters[param].forEach(value => {
        url.searchParams.append(param, value);
      });
    });
    
    console.log('🔄 Applying filters:', url.toString());
    
    // Show loading state
    this.showLoading();
    
    // Fetch new content with timeout and better error handling
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      controller.abort();
      this.isLoading = false;
      this.hideLoading();
      console.error('❌ Filter request timed out');
      // Fallback to page reload
      window.location.href = url.toString();
    }, 10000);
    
    fetch(url.toString(), {
      signal: controller.signal,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
      clearTimeout(timeoutId);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.text();
    })
    .then(html => {
      this.updateContent(html);
      window.history.pushState({}, '', url.toString());
      this.isLoading = false;
      this.hideLoading();
      console.log('✅ Filters applied successfully');
    })
    .catch(error => {
      clearTimeout(timeoutId);
      console.error('❌ Filter error:', error);
      this.isLoading = false;
      this.hideLoading();
      
      // Graceful fallback to page reload
      if (error.name !== 'AbortError') {
        setTimeout(() => {
          window.location.href = url.toString();
        }, 1000);
      }
    });
  },
  
  updateContent(html) {
    const parser = new DOMParser();
    const newDoc = parser.parseFromString(html, 'text/html');
    
    // Update product grid
    const currentGrid = document.querySelector('#main-collection-product-grid');
    const newGrid = newDoc.querySelector('#main-collection-product-grid');
    
    if (currentGrid && newGrid) {
      currentGrid.innerHTML = newGrid.innerHTML;
    }
    
    // Update product count - try multiple methods to get accurate count
    let newCount = 0;
    
    // Method 1: Try to get count from the new HTML's product count element
    const newCountElement = newDoc.getElementById('modernProductCount');
    if (newCountElement) {
      const countMatch = newCountElement.textContent.match(/(\d+)/);
      if (countMatch) {
        newCount = parseInt(countMatch[1]);
      }
    }
    
    // Method 2: If that fails, count products in the updated grid
    if (newCount === 0) {
      newCount = newDoc.querySelectorAll('.product-listing, .product-item, [data-product-id], .product-loop .span-3, .product-loop .span-4, .product-loop .span-6').length;
    }
    
    // Method 3: If still 0, count in current updated grid
    if (newCount === 0) {
      setTimeout(() => {
        newCount = document.querySelectorAll('#main-collection-product-grid .product-listing, #main-collection-product-grid .product-item, #main-collection-product-grid [data-product-id]').length;
        this.updateProductCountDisplay(newCount);
      }, 100);
    }
    
    // Update the product count display
    this.updateProductCountDisplay(newCount);
    
    // Update drawer filter counts and active states
    this.updateFilterStatesFromHTML(newDoc);
  },
  
  updateProductCountDisplay(count) {
    const countElement = document.getElementById('modernProductCount');
    if (countElement) {
      let countText;
      if (count === 0) {
        countText = 'Brak produktów';
      } else if (count === 1) {
        countText = '1 produkt';
      } else if (count >= 2 && count <= 4) {
        countText = `${count} produkty`;
      } else {
        countText = `${count} produktów`;
      }
      countElement.textContent = countText;
      console.log(`✅ Product count updated: ${countText}`);
    }
  },
  
  updateFilterStatesFromHTML(newDoc) {
    // Update filter counts and active states from the new HTML
    const newFilterSections = newDoc.querySelectorAll('.filter-section');
    const currentFilterSections = document.querySelectorAll('#filterDrawer .filter-section');
    
    newFilterSections.forEach((newSection, index) => {
      const currentSection = currentFilterSections[index];
      if (!currentSection) return;
      
      // Update filter option counts and availability
      const newOptions = newSection.querySelectorAll('.filter-option-item');
      const currentOptions = currentSection.querySelectorAll('.filter-option-item');
      
      newOptions.forEach((newOption, optionIndex) => {
        const currentOption = currentOptions[optionIndex];
        if (!currentOption) return;
        
        // Update count
        const newCount = newOption.querySelector('.filter-option-count');
        const currentCount = currentOption.querySelector('.filter-option-count');
        if (newCount && currentCount) {
          currentCount.textContent = newCount.textContent;
        }
        
        // Update disabled state
        const newInput = newOption.querySelector('input');
        const currentInput = currentOption.querySelector('input');
        if (newInput && currentInput) {
          if (newInput.disabled) {
            currentInput.disabled = true;
            currentOption.setAttribute('data-disabled', 'true');
          } else {
            currentInput.disabled = false;
            currentOption.removeAttribute('data-disabled');
          }
        }
      });
    });
  },
  
  showLoading() {
    const wrapper = document.querySelector('.modern-collection-filters');
    if (wrapper) wrapper.classList.add('loading');
  },
  
  hideLoading() {
    const wrapper = document.querySelector('.modern-collection-filters');
    if (wrapper) wrapper.classList.remove('loading');
  }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  // Wait a moment for theme to load, then override
  setTimeout(() => {
    FilterDrawer.init();
    
    // Enhanced button protection - ensure our filter button works correctly
    const filterButton = document.querySelector('.modern-filter-button');
    if (filterButton) {
      // Remove any existing event listeners by cloning
      const newButton = filterButton.cloneNode(true);
      filterButton.parentNode.replaceChild(newButton, filterButton);
      
      // Add only our event listener
      newButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        FilterDrawer.open();
      });
    }
  }, 100);
});
</script>

{% style %}
/* ENHANCED FILTER DRAWER STYLES - Complete Code */

/* Scoped container to prevent style conflicts */
.modern-collection-filters {
  --filter-primary: #1d4ed8;
  --filter-dark: #323232;
  --filter-light: #eeeeee;
  --filter-white: #ffffff;
  position: relative;
}

/* Only apply box-sizing to our filter elements */
.modern-collection-filters .modern-filter-topbar,
.modern-collection-filters .modern-filter-topbar *,
.modern-collection-filters .modern-current-filters,
.modern-collection-filters .modern-current-filters *,
.filter-drawer-container,
.filter-drawer-container * {
  box-sizing: border-box;
}

/* Filter Top Bar - scoped to avoid conflicts */
.modern-collection-filters .modern-filter-topbar {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  /* margin-bottom: 20px !important; */
  padding: 16px 0 !important;
  border-bottom: 1px solid var(--filter-light) !important;
}

.modern-collection-filters .modern-filter-button {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-height: 40px !important;
  padding: 8px 16px !important;
  border: 1px solid var(--text-color, var(--filter-dark)) !important;
  border-radius: 4px !important;
  background: transparent !important;
  color: var(--text-color, var(--filter-dark)) !important;
  font-size: 14px !important;
  font-weight: 700 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  text-decoration: none !important;
  font-family: inherit !important;
  line-height: normal !important;
  margin: 0 !important;
  outline: none !important;
  box-shadow: none !important;
  vertical-align: baseline !important;
  white-space: nowrap !important;
}

.modern-collection-filters .modern-filter-button:hover,
.modern-collection-filters .modern-filter-button:focus {
  background: var(--text-color, var(--filter-dark)) !important;
  color: var(--bg-color, var(--filter-white)) !important;
  transform: translateY(-1px) !important;
  outline: none !important;
  box-shadow: none !important;
}

.modern-collection-filters .modern-filter-button:active {
  transform: translateY(0) !important;
  transition: all 0.1s ease !important;
}

.modern-collection-filters .modern-filter-button svg {
  margin-left: 8px !important;
  width: 12px !important;
  height: 12px !important;
}

.modern-collection-filters .modern-product-count {
  font-size: 16px !important;
  color: var(--filter-dark) !important;
  font-weight: bold !important;
}

/* Current Filters Display - scoped */
.modern-collection-filters .modern-current-filters {
  margin: 16px 0 24px 0 !important;
  padding: 0 !important;
}

.modern-collection-filters .modern-current-filters-title {
  font-size: 12px !important;
  font-weight: 600 !important;
  color: var(--filter-dark) !important;
  margin: 0 0 8px 0 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
}

.modern-collection-filters .modern-current-filters-list {
  list-style: none !important;
  margin: 0 !important;
  padding: 0 !important;
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 6px !important;
}

.modern-collection-filters .modern-current-filter-item {
  margin: 0 !important;
  padding: 0 !important;
}

/* Enhanced filter tags with proper icon positioning */
.modern-collection-filters .modern-current-filter-tag {
  border: 1px solid var(--text-color) !important;
  padding: 6px 12px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  margin: 0 !important;
  border-radius: 16px !important;
  background: transparent !important;
  color: var(--filter-primary) !important;
  font-size: 12px !important;
  font-weight: 500 !important;
  text-decoration: none !important;
  transition: all 0.2s ease !important;
  cursor: pointer !important;
  line-height: 1.4 !important;
  gap: 8px !important;
  max-width: 200px !important;
  min-width: 60px !important;
}

.modern-collection-filters .modern-current-filter-tag:hover {
  background: var(--text-color, var(--filter-dark)) !important;
  color: var(--bg-color, var(--filter-white)) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
}

/* Enhanced remove icon - properly positioned on the right */
.modern-collection-filters .modern-filter-remove-icon {
  margin-left: 0 !important;
  font-size: 14px !important;
  font-weight: bold !important;
  opacity: 1 !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 18px !important;
  height: 18px !important;
  border-radius: 50% !important;
  background: rgba(0, 0, 0, 0.1) !important;
  transition: all 0.2s ease !important;
  flex-shrink: 0 !important;
  order: 2 !important;
}

/* Remove icon hover state */
.modern-collection-filters .modern-current-filter-tag:hover .modern-filter-remove-icon {
  background: rgba(255, 255, 255, 0.3) !important;
  color: inherit !important;
  transform: scale(1.1) !important;
}

/* Enhanced "Clear All" button */
.modern-collection-filters .modern-clear-all-filters {
  border: 2px solid #dc2626 !important;
  padding: 8px 16px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  margin: 0 !important;
  border-radius: 20px !important;
  background: transparent !important;
  color: #dc2626 !important;
  font-size: 12px !important;
  font-weight: 700 !important;
  text-decoration: none !important;
  transition: all 0.2s ease !important;
  cursor: pointer !important;
  line-height: 1.4 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
  gap: 8px !important;
  min-height: 36px !important;
  max-width: 180px !important;
  min-width: 120px !important;
}

.modern-collection-filters .modern-clear-all-filters:hover {
  background: #dc2626 !important;
  color: var(--bg-color, var(--filter-white)) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3) !important;
}

/* Enhanced × icon for clear all button */
.modern-collection-filters .modern-clear-all-filters::before {
  content: '×' !important;
  margin-right: 0 !important;
  font-size: 16px !important;
  font-weight: bold !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 20px !important;
  height: 20px !important;
  border-radius: 50% !important;
  background: rgba(220, 38, 38, 0.1) !important;
  transition: all 0.2s ease !important;
  order: 2 !important;
  flex-shrink: 0 !important;
}

.modern-collection-filters .modern-clear-all-filters:hover::before {
  background: rgba(255, 255, 255, 0.2) !important;
  transform: rotate(90deg) !important;
}

/* Text elements inside filter tags */
.modern-collection-filters .filter-tag-text,
.modern-collection-filters .clear-all-text {
  flex: 1 !important;
  text-align: left !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  order: 1 !important;
}

/* DRAWER CONTAINER - Completely isolated */
.filter-drawer-container {
  display: none;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 999999 !important;
  pointer-events: none;
  font-family: inherit;
}

/* Backdrop Overlay */
.filter-drawer-container .filter-backdrop {
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background: rgba(0, 0, 0, 0.5) !important;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: auto;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}

.filter-drawer-container .filter-backdrop.active {
  opacity: 1;
}

/* The Actual Drawer */
.filter-drawer-container .filter-drawer {
  position: absolute !important;
  top: 0 !important;
  right: 0 !important;
  width: 400px !important;
  height: 100% !important;
  background: #ffffff !important;
  box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15) !important;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  pointer-events: auto;
  color: var(--filter-dark);
  border-left: 1px solid #e5e7eb !important;
}

.filter-drawer-container .filter-drawer.active {
  transform: translateX(0);
}

/* Fixed Header */
.filter-drawer-container .filter-drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #e5e7eb;
  background: #ffffff !important;
  flex-shrink: 0;
  min-height: 70px;
}

.filter-drawer-container .filter-drawer-title {
  font-size: 18px !important;
  font-weight: 600 !important;
  color: var(--filter-dark) !important;
  margin: 0 !important;
}

.filter-drawer-container .filter-drawer-close {
  background: none !important;
  border: none !important;
  padding: 8px !important;
  cursor: pointer;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s ease;
}

.filter-drawer-container .filter-drawer-close:hover {
  background: var(--filter-light) !important;
}

.filter-drawer-container .filter-drawer-close svg {
  width: 20px;
  height: 20px;
  color: #323232 !important;
  stroke: #323232 !important;
}

/* Scrollable Content */
.filter-drawer-container .filter-drawer-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 0 100px 0;
  -webkit-overflow-scrolling: touch;
}

/* Enhanced scrollbar for webkit browsers */
.filter-drawer-container .filter-drawer-content::-webkit-scrollbar {
  width: 8px;
}

.filter-drawer-container .filter-drawer-content::-webkit-scrollbar-track {
  background: #f1f3f4;
}

.filter-drawer-container .filter-drawer-content::-webkit-scrollbar-thumb {
  background: #c1c8cd;
  border-radius: 4px;
}

.filter-drawer-container .filter-drawer-content::-webkit-scrollbar-thumb:hover {
  background: #a1a8ad;
}

/* Filter Sections */
.filter-drawer-container .filter-section {
  border-bottom: 1px solid #e5e7eb;
  background: #ffffff !important;
}

.filter-drawer-container .filter-section-header {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: #ffffff !important;
  border: none;
  cursor: pointer;
  transition: background-color 0.2s ease;
  font-size: 16px !important;
  font-weight: 600;
  color: var(--filter-dark);
  text-align: left;
}



.filter-drawer-container .filter-section-header:hover {
  background: #f8f9fa !important;
}

.filter-drawer-container .filter-section-arrow {
  transition: transform 0.3s ease;
  color: var(--filter-dark);
  opacity: 0.7;
}

.filter-drawer-container .filter-section-arrow.rotated {
  transform: rotate(180deg);
}

.filter-drawer-container .filter-section-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  background: #ffffff !important;
}

.filter-drawer-container .filter-section-content.active {
  max-height: 400px;
  overflow-y: auto;
}

/* Filter Options - Enhanced specificity to override Shopify theme */
.filter-drawer-container .filter-options {
  padding: 16px 24px;
  background: #ffffff !important;
}

.filter-drawer-container .filter-drawer .filter-option-item {
  display: flex !important;
  align-items: center !important;
  padding: 10px 12px !important;
  margin-bottom: 8px !important;
  background: #ffffff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 6px !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  position: relative !important;
  color: #323232 !important;
}

.filter-drawer-container .filter-drawer .filter-option-item:hover {
  border-color: var(--filter-primary) !important;
  background: #f8f9ff !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 4px rgba(29, 78, 216, 0.1) !important;
}

/* ACTIVE STATE - Selected filters - Maximum specificity */
.filter-drawer-container .filter-drawer .filter-section .filter-option-item.active,
.filter-drawer-container .filter-drawer .filter-option-item.active {
  background: #1d4ed8 !important;
  border-color: #1d4ed8 !important;
  color: #ffffff !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 8px rgba(29, 78, 216, 0.3) !important;
}

/* Active state hover effect - Maximum specificity */
.filter-drawer-container .filter-drawer .filter-section .filter-option-item.active:hover,
.filter-drawer-container .filter-drawer .filter-option-item.active:hover {
  background: #1e40af !important;
  border-color: #1e40af !important;
  color: #ffffff !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(29, 78, 216, 0.4) !important;
}

.filter-drawer-container .filter-drawer .filter-option-item[data-disabled="true"] {
  opacity: 0.5 !important;
  pointer-events: none !important;
}

.filter-drawer-container .filter-drawer .filter-option-item input[type="checkbox"] {
  position: absolute !important;
  opacity: 0 !important;
  pointer-events: none !important;
  width: 1px !important;
  height: 1px !important;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  clip: rect(0, 0, 0, 0) !important;
}

.filter-drawer-container .filter-drawer .filter-option-checkbox {
  width: 16px !important;
  height: 16px !important;
  border: 2px solid #e5e7eb !important;
  border-radius: 3px !important;
  margin-right: 10px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.2s ease !important;
  flex-shrink: 0 !important;
  background: #ffffff !important;
  position: relative !important;
}

/* Active checkbox styling - Maximum specificity */
.filter-drawer-container .filter-drawer .filter-section .filter-option-item.active .filter-option-checkbox,
.filter-drawer-container .filter-drawer .filter-option-item.active .filter-option-checkbox {
  background: #ffffff !important;
  border-color: #ffffff !important;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2) !important;
}

.filter-drawer-container .filter-drawer .filter-section .filter-option-item.active .filter-option-checkbox::after,
.filter-drawer-container .filter-drawer .filter-option-item.active .filter-option-checkbox::after {
  content: '✓' !important;
  color: #1d4ed8 !important;
  font-size: 11px !important;
  font-weight: bold !important;
  line-height: 1 !important;
  position: absolute !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
}

.filter-drawer-container .filter-drawer .filter-option-item:not(.active) .filter-option-checkbox {
  background: #ffffff !important;
  border-color: #e5e7eb !important;
}

.filter-drawer-container .filter-drawer .filter-option-item:not(.active):hover .filter-option-checkbox {
  border-color: var(--filter-primary) !important;
  background: #f8f9ff !important;
}

.filter-drawer-container .filter-drawer .filter-option-label {
  flex: 1 !important;
  font-size: 13px !important;
  font-weight: 500 !important;
  margin-right: 8px !important;
  transition: color 0.2s ease !important;
  color: inherit !important;
}

/* Active label text color - Maximum specificity */
.filter-drawer-container .filter-drawer .filter-section .filter-option-item.active .filter-option-label,
.filter-drawer-container .filter-drawer .filter-option-item.active .filter-option-label {
  color: #ffffff !important;
  font-weight: 600 !important;
}

.filter-drawer-container .filter-drawer .filter-option-count {
  font-size: 14px !important;
  opacity: 0.7 !important;
  padding: 2px 6px !important;
  background: rgba(0, 0, 0, 0.05) !important;
  border-radius: 10px !important;
  transition: all 0.2s ease !important;
  font-weight: 500 !important;
  color: inherit !important;
}

/* Active count styling - Maximum specificity */
.filter-drawer-container .filter-drawer .filter-section .filter-option-item.active .filter-option-count,
.filter-drawer-container .filter-drawer .filter-option-item.active .filter-option-count {
  background: rgba(255, 255, 255, 0.25) !important;
  color: #ffffff !important;
  opacity: 1 !important;
  font-weight: 600 !important;
}

/* Sort Options */
.filter-drawer-container .sort-option input {
  margin-right: 10px;
}

/* Price Range */
.filter-drawer-container .price-range-inputs {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.filter-drawer-container .price-input-group {
  flex: 1;
}

.filter-drawer-container .price-input-group label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: var(--filter-dark);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filter-drawer-container .price-input-group input {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 13px;
  background: #ffffff !important;
  color: var(--filter-dark);
  transition: border-color 0.2s ease;
}

.filter-drawer-container .price-input-group input:focus {
  outline: none;
  border-color: var(--filter-primary);
}

.filter-drawer-container .price-apply-btn {
  width: 100%;
  padding: 12px;
  background: #1d4ed8 !important;
  color: #ffffff !important;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: background-color 0.2s ease;
  box-shadow: 0 2px 4px rgba(29, 78, 216, 0.2);
}

.filter-drawer-container .price-apply-btn:hover {
  background: #1e40af !important;
  box-shadow: 0 4px 8px rgba(29, 78, 216, 0.3);
}

/* Fixed Footer */
.filter-drawer-container .filter-drawer-footer {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px 24px;
  border-top: 1px solid #e5e7eb;
  background: #ffffff !important;
}

.filter-drawer-container .filter-apply-btn {
  width: 100%;
  padding: 16px;
  background: #1d4ed8 !important;
  color: #ffffff !important;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(29, 78, 216, 0.2);
  text-align: center !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.filter-drawer-container .filter-apply-btn:hover {
  background: #1e40af !important;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(29, 78, 216, 0.3);
}

/* Loading State */
.modern-collection-filters.loading {
  opacity: 0.7;
  pointer-events: none;
  position: relative;
}

.modern-collection-filters.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 40px;
  height: 40px;
  margin: -20px 0 0 -20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--filter-primary);
  border-radius: 50%;
  animation: modernFilterSpin 1s linear infinite;
  z-index: 1000;
}

@keyframes modernFilterSpin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .filter-drawer-container .filter-drawer {
    width: 100vw !important;
  }
  
  .modern-collection-filters .modern-filter-topbar {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }

  .modern-collection-filters .modern-filter-button {
    width: 100%;
    justify-content: center;
  }

  .modern-collection-filters .modern-current-filters-list {
    gap: 4px;
  }

  .modern-collection-filters .modern-current-filter-tag,
  .modern-collection-filters .modern-clear-all-filters {
    font-size: 10px !important;
    padding: 8px 12px !important;
    min-height: 40px !important;
  }
  
  .modern-collection-filters .modern-filter-remove-icon {
    width: 20px !important;
    height: 20px !important;
    font-size: 16px !important;
  }
  
  .modern-collection-filters .modern-clear-all-filters {
    min-height: 44px !important;
  }
  
  .modern-collection-filters .modern-clear-all-filters::before {
    width: 22px !important;
    height: 22px !important;
    font-size: 18px !important;
  }

  .filter-drawer-container .filter-section-header {
    padding: 14px 16px;
  }

  .filter-drawer-container .filter-options {
    padding: 8px 16px 16px 16px;
  }

  .filter-drawer-container .filter-drawer-header {
    padding: 16px 20px;
  }

  .filter-drawer-container .filter-drawer-title {
    font-size: 16px !important;
  }
}

/* Focus states for accessibility */
.modern-collection-filters .modern-filter-button:focus,
.modern-collection-filters .modern-current-filter-tag:focus,
.modern-collection-filters .modern-clear-all-filters:focus,
.filter-drawer-container .filter-drawer-close:focus,
.filter-drawer-container .filter-section-header:focus,
.filter-drawer-container .filter-option-item:focus,
.filter-drawer-container .price-input-group input:focus,
.filter-drawer-container .price-apply-btn:focus,
.filter-drawer-container .filter-apply-btn:focus {
  outline: 2px solid var(--filter-primary) !important;
  outline-offset: 2px !important;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .modern-collection-filters .modern-filter-remove-icon {
    background: rgba(0, 0, 0, 0.3) !important;
    border: 1px solid currentColor !important;
  }
  
  .modern-collection-filters .modern-clear-all-filters::before {
    background: rgba(220, 38, 38, 0.3) !important;
    border: 1px solid currentColor !important;
  }
}

/* Safely hide ONLY theme filter elements - NOT product elements */
.collection__page--topbar .button:not(.modern-filter-button),
.collection__page--topbar .slideout__trigger-filters:not(.modern-filter-button),
.collection__horizontal-toolbar .slideout__trigger-filters:not(.modern-filter-button),
.slideout[data-wau-slideout="collection-filters"]:not(#filterDrawerContainer *),
.filter-drawer__filtering__results:not(.modern-current-filters) {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
}

/* Ensure product loop gets proper spacing */
/* .modern-collection-filters .product-loop {
  margin-top: 20px;
} */

/* Prevent any styling conflicts with existing product elements */
.modern-collection-filters .collection,
.modern-collection-filters .product-loop,
.modern-collection-filters .product-listing,
.modern-collection-filters .product-item,
.modern-collection-filters .product-image,
.modern-collection-filters .product-info {
  /* Let these inherit from theme - don't override */
}
{% endstyle %}

{% schema %}
{
  "name": "Enhanced Collection page",
  "max_blocks": 10,
  "settings": [
    {
      "type": "range",
      "id": "items_per_page",
      "min": 2,
      "max": 48,
      "step": 1,
      "label": "Products per page",
      "default": 30
    },
    {
      "type": "range",
      "id": "items_per_row",
      "min": 2,
      "max": 4,
      "step": 1,
      "label": "Products per row",
      "default": 3,
      "info": "Will not apply if offset product grid enabled."
    },
    {
      "type": "checkbox",
      "id": "collection_image",
      "label": "Show collection image",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_count",
      "label": "Show product count",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_savings",
      "label": "Show savings amount",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "sort_by",
      "name": "Sort by",
      "limit": 1,
      "settings": [

      ]
    },
    {
      "type": "filter",
      "name": "Filters",
      "limit": 1,
      "settings": [

      ]
    }
  ]
}
{% endschema %}